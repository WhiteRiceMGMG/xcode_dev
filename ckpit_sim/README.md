#I/F一覧(初期案)

公開I/F名
SWIFT-C間の公開和名　　　　　　　　　 機能ラベル   モジュール
---
アクセル開度(%)                      | pwrtrn     | 
ブレーキ開度(%)                      | pwrtrn     |
クラッチ開度(%)                      | pwrtrn     |
ギアシフト情報(1-5,R,N)              | pwrtrn     |
回転数(rpm)                          | pwrtrn     |
スピード(km/h)                       | pwrtrn     |
エンストフラグ(ビットフラグ)         | prtct      |
IG-ON許可フラグ(ビットフラグ)        | perm       |
ギアシフト許可フラグ(ビットフラグ)   | perm       |
オーバレブ状態フラグ(ビットフラグ)   | prtct      |
半クラ焼きつきフラグ(ビットフラグ)   | prtct      |
ブレーキ焼きつきフラグ(ビットフラグ) | prtct      |
IG-ON状態フラグ                      | perm       |

モジュール名と機能
【】

【pwrtrn集約】
pwrtrnモジュール内のIFを集約する．３種の優先度に分けて関数を差し込む．

【prtct集約】
prtctモジュール内のIFを集約する．３種の優先度に分けて関数を差し込む

【perm集約】
permモジュール内のIFを集約する．３種の優先度分けて関数を差し込む．

【アクセル補正】acelcrt (pwrtrn)
  swiftUIのアクセルスライダーから入力されたアクセル開度(%)を補正して公開する．
  [案１]ノイズ対策として，アクセル開度が前回値と比較して±3%の変化がある場合のみ更新する．
  [案２]ノイズ対策として，アクセル開度にローパスフィルタを適応する．
        ローパス式は次のように設定する．  
        filtered = filtered + α( input - filtered )

【ブレーキ補正】brkcrt (pwrtrn)
  入力されたブレーキ開度(%)を補正して公開する．
  [案１]ノイズ対策としてヒステリシスΔ補正を行う．±5%野変化がある場合のみ更新する．

【クラッチ補正】clthcrt (pwrtrn)
  入力されたクラッチ開度(%)に補正を行い，トルク伝達率に変換して公開する．
  [案１]ノイズ対策として，クラッチローパスフィルタを適応する． 

【ギアシフト情報補正】gearcrt (pwrtrn)
  ギアシフトチェンジ許可の下，入力されたギアシフトをノイズ除去後，演算用定数に変換して公開する．
  [案１]ノイズ対策として前回値と一致したときのみギア情報を確定する．また，ギアシフトチェンジ後は
  一定時間チェンジできないようにするため，カウンターを用いてギアシフト許可状態を変化させる．
  また，これらの処理は同一ギアではシフトチェンジ要求を無視することで処理速度を向上させる．
  補正後のギアシフト情報をギア比に変換する．
  [1,2,3,4,5,R,N] = [3.5, 2.1, 1.4, 1.0, 0.8, 3.2, 0]に基づき変換する．

【有効トルク演算】trqcal (pwrtrn)
  補正済みのアクセル補正値を用いて有効トルクを算出して公開する。
  トルク = MAXトルク x スロットル開度 
  有効トルク = トルク x クラッチ結合率
  
【有効抵抗演算】drgcal (pwrtrn)
  空気抵抗や転がり抵抗などの抵抗を算出して公開する。
  算出値は加速度算出等で使用する。
  
【速度・加速度演算】 velaclcal (pwrtrn)
  加速度と速度を算出して公開する。
  得られた有効トルクとギア比と抵抗から加速度を算出する．
  さらに加速度を用いて速度を算出するして公開する．

【回転数算出】rpmcal
 算出した速度を用いて回転数を求める．
  
【エンスト判定】 enstjdg (prtct)
  エンスト状態を判定して公開する．

【IG状態公開】 igsts (perm)
  IG状態を公開する．

【ギアシフト許可判定】 shtchgjdg (perm)
  シフトチェンジ許可状態を判定して公開する．


【オーバーレブ判定判定】ovrrevjdg (prtct)
  オーバーレブ状態を判定して公開する．

【半クラ焼け付き判定】clhsrcjdg (prtct)
  半クラ焼け付き状態を判定して公開する．

【ブレーキ焼け付き判定】brksrcjdg (prtct)
  ブレーキ焼き付き状態を判定して公開する．

【ig-on許可判定】igonjdg (perm)
  IG-ONを許可するかどうかの判定を行い公開する．

#ざっくり仕様
##全体の流れ
IG-ONしたらアクセル，ブレーキ，クラッチ開度を0%に．シフトはNにセット．
同時にIG-ON状態フラグを除く全ての状態を初期状態に戻す．
アクセル開度を取得し，シフト情報とクラッチ開度とブレーキ開度でスピードと回転数を算出．

[詳細]
アクセル→回転数を操作？ ←違うような．．．！！エンジントルク導入！！
アクセルはスピードと回転数に直結するわけでなく，エンジントルクに直接結びついている（？）
アクセル開度を５０％にすれば，単純モデルでエンジントルクはMAXトルクx50%になる．
ギアはトルク増幅装置だと捉えて，[1,2,3,4,5] = [3.5, 2.1, 1.7, 1.4, 1.1]くらいの定数
で，次にざっくり空気抵抗と転がり抵抗を軽くかけて，加速度はトルク x ギア x (speed x speed x 定数)
加速度を求めたらここから積分して速度を求める．算出した速度を回転数と結びつける？？

[数値モデル]
トルク = MAXトルク x スロットル開度 
有効トルク = トルク x クラッチ結合率
加速度 = ( 有効トルク x ギア比 ) - 抵抗 - ブレーキ
  抵抗 = speed x speed x 定数
速度(次)   =  速度(前) + 加速度 x 刻み幅単位 (確かLAMMPS(仮)で -x/2, +x/2を組み込んだ気が...?)
回転数 = 速度 x ギア比 x 定数

engineTorque = throttle × MAXTORQUE
driveTorque = clutch × engineTorque × gearRatio
brakeForce = brake × MAX-BRAKE-FORCE
airDrag = speed x speed × Cdrag
accel = (driveTorque - brakeForce - airDrag) / mass
speed += accel × dt


結論：シミュレータ演算専用のモジュール作っとく




#コンポーネント(モジュール)ざっくり版
##Powertrain
駆動関係の演算

##Protection
保護ロジック

##Permission
動作許可ロジック

##Bridge
Cロジック提供ロジック




#MarkDownざっくり版
# 大見出し
## 中見出し
### 小見出し

## 箇条書き
- スロットル値
- ブレーキ値
- クラッチ値

**太文字**

## コードを書くとき
`g_sliderValue`
<pre> ```c double g_sliderValue; ``` </pre>
